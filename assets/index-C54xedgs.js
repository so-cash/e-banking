import{t as w}from"./formatting-B24v2g9C.js";import{u as S}from"./accounts-C3yGcd3X.js";import{g as N,h as R,i as h,k as L}from"./VCard-E6wXO2St.js";import{a as U,V as T}from"./VSelect-B1rT8X6J.js";import{V as B}from"./VAlert-DnJnE-n4.js";import{V as J}from"./VSpacer-IJYyzGlP.js";import{V as O}from"./VSwitch-CeQaUuf7.js";import{a as _}from"./VInput-Dl1nzYhv.js";import{A as I,f as D,r as p,w as E,o as M,O as a,D as V,E as c,P as k,I as x,c as i,J as u,M as r,K as l,ak as g,y as j}from"./index-grB62I5q.js";import"./VTextField-BU5C0kLP.js";import"./VChip-CDuDY72a.js";const z={class:"font-weight-black mx-1"},K={class:"text-caption mx-1"},$={class:"text-caption mx-1"},q=r("p",null,"Select the account to pay with",-1),F={class:"d-flex align-center"},G={class:"font-weight-black"},H=I({__name:"index",setup(Q){const v=S(),P=D(()=>v.accounts.filter(n=>{var o;return n.bank.currency==((o=t.value)==null?void 0:o.ccy)})),s=p(),b=p(),t=p(),y=p(0),m=p(!1);E(s,async n=>{var o;if(n&&((o=t.value)!=null&&o.execAddress)){const e=await v.currentApproval(n,t.value.execAddress);y.value=e}});function f(n,o){var d;const e=new URL(b.value.href);n&&e.searchParams.append("r",btoa(JSON.stringify(n))),o&&(n={msg:"Payment failed",error:o,id:t.value.id,account:(d=s.value)==null?void 0:d.address,amount:t.value.amount,ccy:t.value.ccy},e.searchParams.append("r",btoa(JSON.stringify(n)))),window.location.href=e.href}async function C(){if(!s.value)return;t.value||f(void 0,"No payment instruction found");const n=m.value?t.value.amount:y.value+t.value.amount,{tx:o,error:e}=await v.approve(s.value,t.value.execAddress,n);if(e)f(void 0,e);else{const d={msg:"Payment successful",tx:o,id:t.value.id,account:s.value.address,amount:t.value.amount,ccy:t.value.ccy};f(d)}}return M(()=>{const n=new URL(window.location.href);if(!n.searchParams.has("redirect"))throw new Error("No redirect URL found in the URL");b.value=new URL(n.searchParams.get("redirect")),n.searchParams.has("i")||f(void 0,"No payment instruction found in the URL");const o=atob(n.searchParams.get("i"));t.value=JSON.parse(o),v.loadAccounts()}),(n,o)=>a(t)?(x(),V(N,{key:0},{default:c(()=>[i(R,null,{default:c(()=>[u(" Payment Validation ")]),_:1}),i(h,{class:"mx-3"},{default:c(()=>[r("ul",null,[r("li",null,[u(" Pay "),r("span",z,l(a(w)(a(t).amount))+" "+l(a(t).ccy),1)]),r("li",null,"To: "+l(a(t).beneficiary)+" ("+l(a(t).iban)+")",1),r("li",null,[u(" Reference: "),r("span",K,l(a(t).id),1),u("("+l(a(b).origin)+") ",1)]),r("li",null,[u(" Allowing "),r("span",$,l(a(t).execAddress),1),u("to debit your account ")])])]),_:1}),i(h,null,{default:c(()=>[q,i(U,{items:a(P),"item-title":"name","item-value":"address","return-object":"","single-line":"",clearable:"","no-data-text":"Ask your bank to associate your wallet to your account","model-value":a(s),"onUpdate:modelValue":o[0]||(o[0]=e=>g(s)?s.value=e:null)},{selection:c(({item:e})=>[r("div",null,l(e.raw.name)+" : "+l(a(w)(e.raw.balance,e.raw.bank.decimals))+" "+l(e.raw.bank.currency),1)]),item:c(({item:e,props:d})=>[i(T,j(d,{title:""}),{default:c(()=>[u(l(e.raw.name)+" : "+l(a(w)(e.raw.balance,e.raw.bank.decimals))+" "+l(e.raw.bank.currency),1)]),_:2},1040)]),_:1},8,["items","model-value"]),a(s)&&a(y)>0?(x(),V(B,{key:0,density:"comfortable",type:"info",variant:"outlined"},{default:c(()=>[r("div",F,[u(" Current authorization: "),r("span",G,l(a(w)(a(y),a(s).bank.decimals))+" "+l(a(s).bank.currency),1),i(J),i(O,{label:a(m)?"Replace":"Add",density:"compact","hide-details":"",modelValue:a(m),"onUpdate:modelValue":o[1]||(o[1]=e=>g(m)?m.value=e:null)},null,8,["label","modelValue"])])]),_:1})):k("",!0)]),_:1}),i(L,null,{default:c(()=>[i(_,{color:"primary",disabled:!a(s),onClick:C},{default:c(()=>[u("Confirm")]),_:1},8,["disabled"]),i(_,{color:"error",onClick:o[2]||(o[2]=e=>f(void 0,"cancel by user"))},{default:c(()=>[u("Cancel")]),_:1})]),_:1})]),_:1})):k("",!0)}}),A={};typeof A=="function"&&A(H);export{H as default};
