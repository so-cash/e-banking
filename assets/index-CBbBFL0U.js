import{t as w}from"./formatting-CrmIf10V.js";import{u as R}from"./accounts-DdgxIhCB.js";import{g as L,h as U,i as V,k as h}from"./VCard-XzuCdBBQ.js";import{V as T,a as B}from"./VSelect-Ce0AfNtp.js";import{V as J}from"./VAlert-C4p1jrBU.js";import{V as O}from"./VSpacer-DFsYJmZV.js";import{V as _}from"./VSwitch-BctL_paP.js";import{a as k}from"./VInput-Do7IEnac.js";import{A as I,e as E,r as p,w as M,o as j,E as x,O as g,P as t,F as i,M as A,c as u,H as c,J as r,I as l,aw as P,y as z}from"./index-BEvEYfuX.js";import"./VTextField-UYTXgnj_.js";import"./VChip-BPiWOI84.js";const D={class:"font-weight-black mx-1"},F={class:"text-caption mx-1"},H={class:"text-caption mx-1"},$={class:"d-flex align-center"},q={class:"font-weight-black"},G=I({__name:"index",setup(K){const v=R(),S=E(()=>v.accounts.filter(n=>{var e;return n.bank.currency==((e=o.value)==null?void 0:e.ccy)})),s=p(),b=p(),o=p(),y=p(0),m=p(!1);M(s,async n=>{var e;if(n&&((e=o.value)!=null&&e.execAddress)){const a=await v.currentApproval(n,o.value.execAddress);y.value=a}});function f(n,e){var d;const a=new URL(b.value.href);n&&a.searchParams.append("r",btoa(JSON.stringify(n))),e&&(n={msg:"Payment failed",error:e,id:o.value.id,account:(d=s.value)==null?void 0:d.address,amount:o.value.amount,ccy:o.value.ccy},a.searchParams.append("r",btoa(JSON.stringify(n)))),window.location.href=a.href}async function N(){if(!s.value)return;o.value||f(void 0,"No payment instruction found");const n=m.value?o.value.amount:y.value+o.value.amount,{tx:e,error:a}=await v.approve(s.value,o.value.execAddress,n);if(a)f(void 0,a);else{const d={msg:"Payment successful",tx:e,id:o.value.id,account:s.value.address,amount:o.value.amount,ccy:o.value.ccy};f(d)}}return j(()=>{const n=new URL(window.location.href);if(!n.searchParams.has("redirect"))throw new Error("No redirect URL found in the URL");b.value=new URL(n.searchParams.get("redirect")),n.searchParams.has("i")||f(void 0,"No payment instruction found in the URL");const e=atob(n.searchParams.get("i"));o.value=JSON.parse(e),v.loadAccounts()}),(n,e)=>t(o)?(A(),x(L,{key:0},{default:i(()=>[u(U,null,{default:i(()=>e[3]||(e[3]=[c(" Payment Validation ")])),_:1}),u(V,{class:"mx-3"},{default:i(()=>[r("ul",null,[r("li",null,[e[4]||(e[4]=c(" Pay ")),r("span",D,l(t(w)(t(o).amount))+" "+l(t(o).ccy),1)]),r("li",null,"To: "+l(t(o).beneficiary)+" ("+l(t(o).iban)+")",1),r("li",null,[e[5]||(e[5]=c(" Reference: ")),r("span",F,l(t(o).id),1),c("("+l(t(b).origin)+") ",1)]),r("li",null,[e[6]||(e[6]=c(" Allowing ")),r("span",H,l(t(o).execAddress),1),e[7]||(e[7]=c("to debit your account "))])])]),_:1}),u(V,null,{default:i(()=>[e[9]||(e[9]=r("p",null,"Select the account to pay with",-1)),u(T,{items:t(S),"item-title":"name","item-value":"address","return-object":"","single-line":"",clearable:"","no-data-text":"Ask your bank to associate your wallet to your account","model-value":t(s),"onUpdate:modelValue":e[0]||(e[0]=a=>P(s)?s.value=a:null)},{selection:i(({item:a})=>[r("div",null,l(a.raw.name)+" : "+l(t(w)(a.raw.balance,a.raw.bank.decimals))+" "+l(a.raw.bank.currency),1)]),item:i(({item:a,props:d})=>[u(B,z(d,{title:""}),{default:i(()=>[c(l(a.raw.name)+" : "+l(t(w)(a.raw.balance,a.raw.bank.decimals))+" "+l(a.raw.bank.currency),1)]),_:2},1040)]),_:1},8,["items","model-value"]),t(s)&&t(y)>0?(A(),x(J,{key:0,density:"comfortable",type:"info",variant:"outlined"},{default:i(()=>[r("div",$,[e[8]||(e[8]=c(" Current authorization: ")),r("span",q,l(t(w)(t(y),t(s).bank.decimals))+" "+l(t(s).bank.currency),1),u(O),u(_,{label:t(m)?"Replace":"Add",density:"compact","hide-details":"",modelValue:t(m),"onUpdate:modelValue":e[1]||(e[1]=a=>P(m)?m.value=a:null)},null,8,["label","modelValue"])])]),_:1})):g("",!0)]),_:1}),u(h,null,{default:i(()=>[u(k,{color:"primary",disabled:!t(s),onClick:N},{default:i(()=>e[10]||(e[10]=[c("Confirm")])),_:1},8,["disabled"]),u(k,{color:"error",onClick:e[2]||(e[2]=a=>f(void 0,"cancel by user"))},{default:i(()=>e[11]||(e[11]=[c("Cancel")])),_:1})]),_:1})]),_:1})):g("",!0)}}),C={};typeof C=="function"&&C(G);export{G as default};
